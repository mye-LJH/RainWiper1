/*============================================================
 * oled.c  --  SSD1306 OLED I2C驱动完整实现（软件模拟I2C）
 *
 * 项目：基于STC89C52单片机的智能汽车雨刮器模拟系统
 * 作者：梁嘉惠  学号：3222004950
 * 学校：五邑大学 电子与信息工程学院  班级：220710
 * 指导教师：龙佳乐 副教授
 * 编译器：Keil C51  主频：11.0592MHz
 *============================================================
 * 实现说明：
 *  - 采用软件模拟I2C（P1.6=SCL, P1.7=SDA）
 *  - SSD1306工作在Page寻址模式（0x02命令设置）
 *  - 8×16 ASCII字库，支持空格(0x20)到波浪号(0x7E)全范围
 *  - OLED_ShowStr/ShowChar/ShowNum均基于Page模式定位
 *  - 注意：STC89C52 P1口为准双向口，SDA输出0时为强驱动低，
 *    SDA输出1时为弱上拉，I2C上拉电阻(4.7kΩ)保证信号质量
 *============================================================*/

#include "oled.h"
#include <string.h>

/*============================================================
 * 8×16 ASCII点阵字库（0x20~0x7E，每字符16字节）
 * 格式：先上8行(Page0)，再下8行(Page1)，列从左到右
 * 字符宽度8像素，高度16像素（占用2个Page）
 *============================================================*/
code unsigned char F8X16[][16] = {
/* 0x20 空格 ' ' */  {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
/* 0x21 '!' */       {0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0x00,0x00,0x00,0x00},
/* 0x22 '"' */       {0x00,0x10,0x0C,0x06,0x10,0x0C,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
/* 0x23 '#' */       {0x40,0xC0,0x78,0x40,0xC0,0x78,0x40,0x00,0x04,0x3F,0x04,0x04,0x3F,0x04,0x04,0x00},
/* 0x24 '$' */       {0x00,0x70,0x88,0xFC,0x08,0x30,0x00,0x00,0x00,0x18,0x20,0xFF,0x21,0x1E,0x00,0x00},
/* 0x25 '%' */       {0xF0,0x08,0xF0,0x00,0xE0,0x18,0x00,0x00,0x00,0x21,0x1C,0x03,0x1E,0x21,0x1E,0x00},
/* 0x26 '&' */       {0x00,0xF0,0x08,0x88,0x70,0x00,0x00,0x00,0x1E,0x21,0x23,0x24,0x19,0x27,0x21,0x10},
/* 0x27 ''' */       {0x10,0x16,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
/* 0x28 '(' */       {0x00,0x00,0x00,0xE0,0x18,0x04,0x02,0x00,0x00,0x00,0x00,0x07,0x18,0x20,0x40,0x00},
/* 0x29 ')' */       {0x00,0x02,0x04,0x18,0xE0,0x00,0x00,0x00,0x00,0x40,0x20,0x18,0x07,0x00,0x00,0x00},
/* 0x2A '*' */       {0x40,0x40,0x80,0xF0,0x80,0x40,0x40,0x00,0x02,0x02,0x01,0x0F,0x01,0x02,0x02,0x00},
/* 0x2B '+' */       {0x00,0x00,0x00,0xF0,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x1F,0x01,0x01,0x01,0x00},
/* 0x2C ',' */       {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xB0,0x70,0x00,0x00,0x00,0x00,0x00},
/* 0x2D '-' */       {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01},
/* 0x2E '.' */       {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x00,0x00,0x00},
/* 0x2F '/' */       {0x00,0x00,0x00,0x00,0x80,0x60,0x18,0x04,0x60,0x18,0x06,0x01,0x00,0x00,0x00,0x00},
/* 0x30 '0' */       {0x00,0xE0,0x10,0x08,0x08,0x10,0xE0,0x00,0x00,0x0F,0x10,0x20,0x20,0x10,0x0F,0x00},
/* 0x31 '1' */       {0x00,0x10,0x10,0xF8,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00},
/* 0x32 '2' */       {0x00,0x70,0x08,0x08,0x08,0x88,0x70,0x00,0x00,0x30,0x28,0x24,0x22,0x21,0x30,0x00},
/* 0x33 '3' */       {0x00,0x30,0x08,0x88,0x88,0x48,0x30,0x00,0x00,0x18,0x20,0x20,0x20,0x11,0x0E,0x00},
/* 0x34 '4' */       {0x00,0x00,0xC0,0x20,0x10,0xF8,0x00,0x00,0x00,0x07,0x04,0x24,0x24,0x3F,0x24,0x00},
/* 0x35 '5' */       {0x00,0xF8,0x08,0x88,0x88,0x08,0x08,0x00,0x00,0x19,0x21,0x20,0x20,0x11,0x0E,0x00},
/* 0x36 '6' */       {0x00,0xE0,0x10,0x88,0x88,0x18,0x00,0x00,0x00,0x0F,0x11,0x20,0x20,0x11,0x0E,0x00},
/* 0x37 '7' */       {0x00,0x18,0x08,0x08,0xC8,0x38,0x08,0x00,0x00,0x00,0x00,0x3F,0x00,0x00,0x00,0x00},
/* 0x38 '8' */       {0x00,0x70,0x88,0x08,0x08,0x88,0x70,0x00,0x00,0x1C,0x22,0x21,0x21,0x22,0x1C,0x00},
/* 0x39 '9' */       {0x00,0x70,0x88,0x08,0x08,0x88,0x70,0x00,0x00,0x00,0x21,0x21,0x11,0x0E,0x00,0x00},
/* 0x3A ':' */       {0x00,0x00,0x00,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x00},
/* 0x3B ';' */       {0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x60,0x00,0x00,0x00,0x00},
/* 0x3C '<' */       {0x00,0x00,0x80,0x40,0x20,0x10,0x08,0x00,0x00,0x01,0x02,0x04,0x08,0x10,0x20,0x00},
/* 0x3D '=' */       {0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x00,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x00},
/* 0x3E '>' */       {0x00,0x08,0x10,0x20,0x40,0x80,0x00,0x00,0x00,0x20,0x10,0x08,0x04,0x02,0x01,0x00},
/* 0x3F '?' */       {0x00,0x70,0x48,0x08,0x08,0x08,0xF0,0x00,0x00,0x00,0x00,0x30,0x36,0x01,0x00,0x00},
/* 0x40 '@' */       {0xC0,0x30,0xC8,0x28,0xE8,0x10,0xE0,0x00,0x07,0x18,0x27,0x24,0x23,0x14,0x0B,0x00},
/* 0x41 'A' */       {0x00,0x00,0xC0,0x38,0xE0,0x00,0x00,0x00,0x20,0x3C,0x23,0x02,0x02,0x27,0x38,0x20},
/* 0x42 'B' */       {0x08,0xF8,0x88,0x88,0x88,0x70,0x00,0x00,0x20,0x3F,0x20,0x20,0x20,0x11,0x0E,0x00},
/* 0x43 'C' */       {0xC0,0x30,0x08,0x08,0x08,0x08,0x38,0x00,0x07,0x18,0x20,0x20,0x20,0x10,0x08,0x00},
/* 0x44 'D' */       {0x08,0xF8,0x08,0x08,0x08,0x10,0xE0,0x00,0x20,0x3F,0x20,0x20,0x20,0x10,0x0F,0x00},
/* 0x45 'E' */       {0x08,0xF8,0x88,0x88,0xE8,0x08,0x10,0x00,0x20,0x3F,0x20,0x20,0x23,0x20,0x18,0x00},
/* 0x46 'F' */       {0x08,0xF8,0x88,0x88,0xE8,0x08,0x10,0x00,0x20,0x3F,0x20,0x00,0x03,0x00,0x00,0x00},
/* 0x47 'G' */       {0xC0,0x30,0x08,0x08,0x08,0x38,0x00,0x00,0x07,0x18,0x20,0x20,0x22,0x1E,0x02,0x00},
/* 0x48 'H' */       {0x08,0xF8,0x08,0x00,0x00,0x08,0xF8,0x08,0x20,0x3F,0x21,0x01,0x01,0x21,0x3F,0x20},
/* 0x49 'I' */       {0x00,0x08,0x08,0xF8,0x08,0x08,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00},
/* 0x4A 'J' */       {0x00,0x00,0x08,0x08,0xF8,0x08,0x08,0x00,0xC0,0x80,0x80,0x80,0x7F,0x00,0x00,0x00},
/* 0x4B 'K' */       {0x08,0xF8,0x88,0xC0,0x28,0x18,0x08,0x00,0x20,0x3F,0x20,0x01,0x26,0x38,0x20,0x00},
/* 0x4C 'L' */       {0x08,0xF8,0x08,0x00,0x00,0x00,0x00,0x00,0x20,0x3F,0x20,0x20,0x20,0x20,0x30,0x00},
/* 0x4D 'M' */       {0x08,0xF8,0x30,0xC0,0x30,0xF8,0x08,0x00,0x20,0x3F,0x20,0x00,0x20,0x3F,0x20,0x00},
/* 0x4E 'N' */       {0x08,0xF8,0x10,0x60,0x80,0x08,0xF8,0x08,0x20,0x3F,0x20,0x00,0x01,0x27,0x3E,0x20},
/* 0x4F 'O' */       {0xE0,0x10,0x08,0x08,0x08,0x10,0xE0,0x00,0x0F,0x10,0x20,0x20,0x20,0x10,0x0F,0x00},
/* 0x50 'P' */       {0x08,0xF8,0x08,0x08,0x08,0x08,0xF0,0x00,0x20,0x3F,0x21,0x01,0x01,0x01,0x00,0x00},
/* 0x51 'Q' */       {0xE0,0x10,0x08,0x08,0x08,0x10,0xE0,0x00,0x0F,0x18,0x24,0x24,0x38,0x50,0x4F,0x00},
/* 0x52 'R' */       {0x08,0xF8,0x88,0x88,0x88,0x88,0x70,0x00,0x20,0x3F,0x20,0x00,0x03,0x0C,0x30,0x20},
/* 0x53 'S' */       {0x00,0x70,0x88,0x08,0x08,0x08,0x38,0x00,0x00,0x38,0x20,0x21,0x21,0x22,0x1C,0x00},
/* 0x54 'T' */       {0x18,0x08,0x08,0xF8,0x08,0x08,0x18,0x00,0x00,0x00,0x20,0x3F,0x20,0x00,0x00,0x00},
/* 0x55 'U' */       {0x08,0xF8,0x08,0x00,0x00,0x08,0xF8,0x08,0x00,0x1F,0x20,0x20,0x20,0x20,0x1F,0x00},
/* 0x56 'V' */       {0x08,0x78,0x88,0x00,0x00,0xC8,0x38,0x08,0x00,0x00,0x07,0x38,0x0E,0x01,0x00,0x00},
/* 0x57 'W' */       {0xF8,0x08,0x00,0xF8,0x00,0x08,0xF8,0x00,0x03,0x3C,0x07,0x00,0x07,0x3C,0x03,0x00},
/* 0x58 'X' */       {0x08,0x18,0x68,0x80,0x80,0x68,0x18,0x08,0x20,0x30,0x2C,0x03,0x03,0x2C,0x30,0x20},
/* 0x59 'Y' */       {0x08,0x38,0xC8,0x00,0xC8,0x38,0x08,0x00,0x00,0x00,0x20,0x3F,0x20,0x00,0x00,0x00},
/* 0x5A 'Z' */       {0x10,0x08,0x08,0x08,0xC8,0x38,0x08,0x00,0x20,0x28,0x24,0x22,0x21,0x30,0x00,0x00},
/* 0x5B '[' */       {0x00,0x00,0x00,0xFE,0x02,0x02,0x02,0x00,0x00,0x00,0x00,0x7F,0x40,0x40,0x40,0x00},
/* 0x5C '\' */       {0x00,0x04,0x18,0x60,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x06,0x18,0x60,0x00},
/* 0x5D ']' */       {0x00,0x02,0x02,0x02,0xFE,0x00,0x00,0x00,0x00,0x40,0x40,0x40,0x7F,0x00,0x00,0x00},
/* 0x5E '^' */       {0x00,0x00,0x04,0x02,0x02,0x02,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
/* 0x5F '_' */       {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80},
/* 0x60 '`' */       {0x00,0x02,0x02,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
/* 0x61 'a' */       {0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x19,0x24,0x22,0x22,0x22,0x3F,0x20},
/* 0x62 'b' */       {0x08,0xF8,0x00,0x80,0x80,0x00,0x00,0x00,0x00,0x3F,0x11,0x20,0x20,0x11,0x0E,0x00},
/* 0x63 'c' */       {0x00,0x00,0x00,0x80,0x80,0x80,0x00,0x00,0x00,0x0E,0x11,0x20,0x20,0x20,0x11,0x00},
/* 0x64 'd' */       {0x00,0x00,0x00,0x80,0x80,0x88,0xF8,0x00,0x00,0x0E,0x11,0x20,0x20,0x10,0x3F,0x20},
/* 0x65 'e' */       {0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x1F,0x22,0x22,0x22,0x22,0x13,0x00},
/* 0x66 'f' */       {0x00,0x80,0x80,0xE0,0x80,0x80,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00},
/* 0x67 'g' */       {0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x6B,0x94,0x94,0x94,0x93,0x60,0x00},
/* 0x68 'h' */       {0x08,0xF8,0x00,0x80,0x80,0x80,0x00,0x00,0x20,0x3F,0x21,0x00,0x00,0x20,0x3F,0x20},
/* 0x69 'i' */       {0x00,0x80,0x98,0x98,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00},
/* 0x6A 'j' */       {0x00,0x00,0x00,0x80,0x98,0x98,0x00,0x00,0x00,0xC0,0x80,0x80,0x80,0x7F,0x00,0x00},
/* 0x6B 'k' */       {0x08,0xF8,0x00,0x00,0x80,0x80,0x80,0x00,0x20,0x3F,0x24,0x02,0x2D,0x30,0x20,0x00},
/* 0x6C 'l' */       {0x00,0x08,0x08,0xF8,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00},
/* 0x6D 'm' */       {0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x20,0x3F,0x20,0x00,0x3F,0x20,0x00,0x3F},
/* 0x6E 'n' */       {0x80,0x80,0x00,0x80,0x80,0x80,0x00,0x00,0x20,0x3F,0x21,0x00,0x00,0x20,0x3F,0x20},
/* 0x6F 'o' */       {0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x1F,0x20,0x20,0x20,0x20,0x1F,0x00},
/* 0x70 'p' */       {0x80,0x80,0x00,0x80,0x80,0x00,0x00,0x00,0x80,0xFF,0xA1,0x20,0x20,0x11,0x0E,0x00},
/* 0x71 'q' */       {0x00,0x00,0x80,0x80,0x00,0x80,0x80,0x00,0x00,0x0E,0x11,0x20,0xA0,0xFF,0x80,0x00},
/* 0x72 'r' */       {0x80,0x80,0x80,0x00,0x80,0x80,0x80,0x00,0x20,0x20,0x3F,0x21,0x20,0x00,0x01,0x00},
/* 0x73 's' */       {0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x33,0x24,0x24,0x24,0x24,0x19,0x00},
/* 0x74 't' */       {0x00,0x80,0x80,0xE0,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x1F,0x20,0x20,0x00,0x00},
/* 0x75 'u' */       {0x80,0x80,0x00,0x00,0x00,0x80,0x80,0x00,0x00,0x1F,0x20,0x20,0x20,0x10,0x3F,0x20},
/* 0x76 'v' */       {0x80,0x80,0x80,0x00,0x80,0x80,0x80,0x00,0x00,0x01,0x0E,0x30,0x08,0x06,0x01,0x00},
/* 0x77 'w' */       {0x80,0x80,0x00,0x80,0x00,0x80,0x80,0x80,0x0F,0x30,0x0C,0x03,0x0C,0x30,0x0F,0x00},
/* 0x78 'x' */       {0x00,0x80,0x80,0x00,0x00,0x80,0x80,0x00,0x00,0x20,0x31,0x2E,0x0E,0x31,0x20,0x00},
/* 0x79 'y' */       {0x80,0x80,0x80,0x00,0x00,0x80,0x80,0x80,0x00,0x81,0x8E,0x70,0x18,0x06,0x01,0x00},
/* 0x7A 'z' */       {0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x21,0x30,0x2C,0x22,0x21,0x30,0x00},
/* 0x7B '{' */       {0x00,0x00,0x00,0x00,0x80,0x7C,0x02,0x02,0x00,0x00,0x00,0x10,0x39,0x06,0x00,0x00},
/* 0x7C '|' */       {0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00},
/* 0x7D '}' */       {0x00,0x02,0x02,0x7C,0x80,0x00,0x00,0x00,0x00,0x00,0x06,0x39,0x10,0x00,0x00,0x00},
/* 0x7E '~' */       {0x00,0x06,0x01,0x01,0x02,0x02,0x04,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
};

/*============================================================
 *  软件I2C底层函数
 *============================================================*/

static void i2c_delay(void)
{
    _nop_(); _nop_(); _nop_(); _nop_();
    _nop_(); _nop_(); _nop_(); _nop_();
}

static void i2c_start(void)
{
    OLED_SDA = 1; i2c_delay();
    OLED_SCL = 1; i2c_delay();
    OLED_SDA = 0; i2c_delay();     /* SDA下降沿（SCL高期间） = START */
    OLED_SCL = 0; i2c_delay();
}

static void i2c_stop(void)
{
    OLED_SDA = 0; i2c_delay();
    OLED_SCL = 1; i2c_delay();
    OLED_SDA = 1; i2c_delay();     /* SDA上升沿（SCL高期间） = STOP  */
}

static void i2c_write_byte(unsigned char dat)
{
    unsigned char i;
    for (i = 0; i < 8; i++)
    {
        OLED_SDA = (dat & 0x80) ? 1 : 0;
        dat <<= 1;
        i2c_delay();
        OLED_SCL = 1; i2c_delay();
        OLED_SCL = 0; i2c_delay();
    }
    /* 接收ACK（此处忽略ACK，简化实现；实际使用中SSD1306总会发ACK） */
    OLED_SDA = 1;
    i2c_delay();
    OLED_SCL = 1; i2c_delay();
    OLED_SCL = 0; i2c_delay();
}

/*------------------------------------------------------------
 * oled_write_cmd()  发送命令字节到SSD1306
 *------------------------------------------------------------*/
static void oled_write_cmd(unsigned char cmd)
{
    i2c_start();
    i2c_write_byte((OLED_ADDR << 1) | 0x00);   /* 写地址 */
    i2c_write_byte(0x00);                        /* Control byte: Co=0, D/C=0 命令 */
    i2c_write_byte(cmd);
    i2c_stop();
}

/*------------------------------------------------------------
 * oled_write_dat()  发送数据字节到SSD1306（写入GDDRAM）
 *------------------------------------------------------------*/
static void oled_write_dat(unsigned char dat)
{
    i2c_start();
    i2c_write_byte((OLED_ADDR << 1) | 0x00);   /* 写地址 */
    i2c_write_byte(0x40);                        /* Control byte: Co=0, D/C=1 数据 */
    i2c_write_byte(dat);
    i2c_stop();
}

/*------------------------------------------------------------
 * oled_set_pos()  设置显示起始位置（Page模式）
 *   x: 列地址  0~127
 *   y: Page地址 0~7（y=0对应最上方8像素行）
 *------------------------------------------------------------*/
static void oled_set_pos(unsigned char x, unsigned char y)
{
    oled_write_cmd(0xB0 | (y & 0x07));          /* 设置Page地址 */
    oled_write_cmd(0x00 | (x & 0x0F));          /* 列地址低4位  */
    oled_write_cmd(0x10 | ((x >> 4) & 0x0F));   /* 列地址高4位  */
}

/*============================================================
 *  公开函数实现
 *============================================================*/

/*------------------------------------------------------------
 * OLED_Init()  SSD1306初始化（标准上电初始化序列）
 *------------------------------------------------------------*/
void OLED_Init(void)
{
    unsigned char i;
    /* SSD1306标准初始化命令序列 */
    static code unsigned char init_seq[] =
    {
        0xAE,           /* 关闭显示（初始化期间）         */
        0x00, 0x10,     /* 设置列起始地址低/高位（Page模式）*/
        0x40,           /* 设置显示起始行 = 0             */
        0x81, 0xFF,     /* 设置对比度 = 0xFF（最亮）      */
        0xA1,           /* 列反向 Segment Remap（左→右）  */
        0xA6,           /* 正常显示（0=黑，1=亮）         */
        0xA8, 0x3F,     /* 多路复用率 = 64（0x3F）        */
        0xC8,           /* COM扫描方向 = 从COM63到COM0    */
        0xD3, 0x00,     /* 显示偏移 = 0                   */
        0xD5, 0x80,     /* 时钟分频/震荡频率              */
        0xD9, 0xF1,     /* 预充电周期                     */
        0xDA, 0x12,     /* COM引脚硬件配置                */
        0xDB, 0x40,     /* VCOMH反压电平                  */
        0x20, 0x02,     /* 内存寻址模式 = 页面寻址模式    */
        0x8D, 0x14,     /* 使能电荷泵（对于内置升压的模块）*/
        0xAF,           /* 打开显示                       */
    };

    for (i = 0; i < sizeof(init_seq); i++)
        oled_write_cmd(init_seq[i]);
}

/*------------------------------------------------------------
 * OLED_Clear()  全屏清空（所有像素置0=黑）
 *------------------------------------------------------------*/
void OLED_Clear(void)
{
    unsigned char page, col;
    for (page = 0; page < 8; page++)
    {
        oled_set_pos(0, page);
        for (col = 0; col < 128; col++)
            oled_write_dat(0x00);
    }
}

/*------------------------------------------------------------
 * OLED_ShowChar()  显示单个ASCII字符（8×16点阵）
 *   x   : 列地址（0~120，8的倍数时对齐）
 *   y   : Page地址（0,2,4,6 → 行0,1,2,3）
 *   c   : ASCII字符（0x20~0x7E）
 *------------------------------------------------------------*/
void OLED_ShowChar(unsigned char x, unsigned char y, char c)
{
    unsigned char i;
    unsigned char idx;

    if (c < 0x20 || c > 0x7E)
        c = ' ';                    /* 超出范围显示空格 */
    idx = (unsigned char)(c - 0x20);

    /* 上半部分（Page = y） */
    oled_set_pos(x, y);
    for (i = 0; i < 8; i++)
        oled_write_dat(F8X16[idx][i]);

    /* 下半部分（Page = y+1） */
    oled_set_pos(x, y + 1);
    for (i = 0; i < 8; i++)
        oled_write_dat(F8X16[idx][i + 8]);
}

/*------------------------------------------------------------
 * OLED_ShowStr()  显示ASCII字符串
 *   x  : 起始列地址
 *   y  : Page地址（0,2,4,6）
 *   str: 以'\0'结尾的字符串
 *------------------------------------------------------------*/
void OLED_ShowStr(unsigned char x, unsigned char y, char *str)
{
    while (*str != '\0')
    {
        OLED_ShowChar(x, y, *str);
        x += 8;         /* 每字符宽8像素，向右移动 */
        if (x >= 128)   /* 超出屏宽，换行 */
        {
            x = 0;
            y += 2;     /* 8×16字体，每行占2个Page */
        }
        str++;
    }
}

/*------------------------------------------------------------
 * OLED_ShowNum()  显示无符号整数（0~65535）
 *   x    : 起始列地址
 *   y    : Page地址
 *   num  : 要显示的数值
 *   len  : 显示位数（不足补空格前导）
 *------------------------------------------------------------*/
void OLED_ShowNum(unsigned char x, unsigned char y,
                  unsigned int num, unsigned char len)
{
    unsigned char buf[6];
    unsigned char i;

    /* 从低位到高位提取各位数字 */
    for (i = 0; i < len; i++)
    {
        buf[len - 1 - i] = (unsigned char)(num % 10) + '0';
        num /= 10;
    }
    buf[len] = '\0';

    OLED_ShowStr(x, y, (char *)buf);
}

/*------------------------------------------------------------
 * OLED_RefreshAll()  根据系统状态刷新整屏显示
 *   adc_val   : ADC0832采集值（0~255）
 *   rain_lv   : 雨量等级（0=无雨,1=小雨,2=中雨,3=大雨）
 *   pwm_duty  : PWM占空比（0~99，单位%）
 *   auto_mode : 运行模式（1=自动，0=手动）
 *------------------------------------------------------------*/
void OLED_RefreshAll(unsigned char adc_val,
                     unsigned char rain_lv,
                     unsigned char pwm_duty,
                     unsigned char auto_mode)
{
    /* === 第1行（y=0）：ADC值 === */
    OLED_ShowStr(0, 0, "ADC:   ");
    OLED_ShowNum(32, 0, adc_val, 3);    /* 例："ADC:189" */

    /* === 第2行（y=2）：雨量等级 === */
    OLED_ShowStr(0, 2, "Lv:");
    switch (rain_lv)
    {
        case 0: OLED_ShowStr(24, 2, "None     "); break;
        case 1: OLED_ShowStr(24, 2, "Light    "); break;
        case 2: OLED_ShowStr(24, 2, "Mid      "); break;
        case 3: OLED_ShowStr(24, 2, "Heavy    "); break;
        default: OLED_ShowStr(24, 2, "---      "); break;
    }

    /* === 第3行（y=4）：PWM占空比 === */
    OLED_ShowStr(0, 4, "PWM:");
    OLED_ShowNum(32, 4, pwm_duty, 2);
    OLED_ShowStr(48, 4, "%       ");

    /* === 第4行（y=6）：运行模式 === */
    if (auto_mode)
        OLED_ShowStr(0, 6, "Mode:AUTO   ");
    else
        OLED_ShowStr(0, 6, "Mode:MANUAL ");
}

/*------------------------------------------------------------
 * OLED_ShowBootScreen()  上电开机画面（含个人信息，显示2秒）
 * PCB丝印信息与OLED开机画面保持一致：
 *   五邑大学  220710班  3222004950  梁嘉惠
 *------------------------------------------------------------*/
void OLED_ShowBootScreen(void)
{
    OLED_Clear();
    OLED_ShowStr(0, 0, "RainWiper V4.0");   /* 第1行：项目名 */
    OLED_ShowStr(0, 2, "Wuyiu  Univ.  ");   /* 第2行：五邑大学（拼音）*/
    OLED_ShowStr(0, 4, "220710 3222004950"); /* 第3行：班级+学号 */
    OLED_ShowStr(0, 6, "Liang  JiaoHui");   /* 第4行：梁嘉惠（拼音） */
}
